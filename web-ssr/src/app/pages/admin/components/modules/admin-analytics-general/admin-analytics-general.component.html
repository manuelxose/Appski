<div class="analytics-general-container">
  <!-- Header -->
  <div class="analytics-header">
    <app-admin-breadcrumbs [items]="breadcrumbs"></app-admin-breadcrumbs>

    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">üìä Analytics General</h1>
        <p class="page-subtitle">
          Vista completa de m√©tricas y KPIs del sistema
        </p>
      </div>

      <div class="header-actions">
        <button
          class="btn btn-secondary"
          (click)="refreshData()"
          [disabled]="isLoading()"
        >
          üîÑ Actualizar
        </button>
        <div class="export-dropdown">
          <button class="btn btn-secondary">üì• Exportar</button>
          <div class="dropdown-menu">
            <button (click)="exportData('csv')">CSV</button>
            <button (click)="exportData('excel')">Excel</button>
            <button (click)="exportData('pdf')">PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="date-range-filters">
      <span class="filter-label">Per√≠odo:</span>
      <div class="btn-group">
        <button
          class="btn btn-filter"
          [class.active]="dateRangePreset() === 'today'"
          (click)="setDateRangePreset('today')"
        >
          Hoy
        </button>
        <button
          class="btn btn-filter"
          [class.active]="dateRangePreset() === 'week'"
          (click)="setDateRangePreset('week')"
        >
          Semana
        </button>
        <button
          class="btn btn-filter"
          [class.active]="dateRangePreset() === 'month'"
          (click)="setDateRangePreset('month')"
        >
          Mes
        </button>
        <button
          class="btn btn-filter"
          [class.active]="dateRangePreset() === 'quarter'"
          (click)="setDateRangePreset('quarter')"
        >
          Trimestre
        </button>
        <button
          class="btn btn-filter"
          [class.active]="dateRangePreset() === 'year'"
          (click)="setDateRangePreset('year')"
        >
          A√±o
        </button>
        <button
          class="btn btn-filter"
          [class.active]="dateRangePreset() === 'custom'"
          (click)="setDateRangePreset('custom')"
        >
          Personalizado
        </button>
      </div>
    </div>

    @if (dateRangePreset() === 'custom') {
    <div class="custom-date-range">
      <div class="date-input-group">
        <label for="startDate">Desde:</label>
        <input type="date" id="startDate" [(ngModel)]="customStartDate" />
      </div>
      <div class="date-input-group">
        <label for="endDate">Hasta:</label>
        <input type="date" id="endDate" [(ngModel)]="customEndDate" />
      </div>
      <button class="btn btn-primary" (click)="applyCustomDateRange()">
        Aplicar
      </button>
    </div>
    }

    <div class="comparison-filters">
      <span class="filter-label">Comparar:</span>
      <div class="btn-group">
        <button
          class="btn btn-filter btn-sm"
          [class.active]="comparisonPeriod() === 'none'"
          (click)="setComparisonPeriod('none')"
        >
          Sin comparar
        </button>
        <button
          class="btn btn-filter btn-sm"
          [class.active]="comparisonPeriod() === 'yoy'"
          (click)="setComparisonPeriod('yoy')"
        >
          A√±o anterior
        </button>
        <button
          class="btn btn-filter btn-sm"
          [class.active]="comparisonPeriod() === 'mom'"
          (click)="setComparisonPeriod('mom')"
        >
          Mes anterior
        </button>
        <button
          class="btn btn-filter btn-sm"
          [class.active]="comparisonPeriod() === 'wow'"
          (click)="setComparisonPeriod('wow')"
        >
          Semana anterior
        </button>
      </div>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error()) {
  <div class="alert alert-error">‚ùå {{ error() }}</div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
  <app-admin-loader></app-admin-loader>
  } @else {
  <!-- KPI Cards -->
  <div class="kpi-grid">
    <!-- Total Users -->
    <app-admin-stat-card
      icon="üë•"
      label="Total Usuarios"
      [value]="formatNumber(metrics().totalUsers.current)"
      [subtitle]="comparisonLabel()"
      [trend]="metrics().totalUsers.trend"
      [change]="metrics().totalUsers.changePercent"
      variant="primary"
    ></app-admin-stat-card>

    <!-- Active Users -->
    <app-admin-stat-card
      icon="‚ö°"
      label="Usuarios Activos (MAU)"
      [value]="formatNumber(metrics().activeUsers.current)"
      [subtitle]="comparisonLabel()"
      [trend]="metrics().activeUsers.trend"
      [change]="metrics().activeUsers.changePercent"
      variant="success"
    ></app-admin-stat-card>

    <!-- Total Bookings -->
    <app-admin-stat-card
      icon="üìÖ"
      label="Total Reservas"
      [value]="formatNumber(metrics().totalBookings.current)"
      [subtitle]="comparisonLabel()"
      [trend]="metrics().totalBookings.trend"
      [change]="metrics().totalBookings.changePercent"
      variant="info"
    ></app-admin-stat-card>

    <!-- Conversion Rate -->
    <app-admin-stat-card
      icon="üéØ"
      label="Tasa de Conversi√≥n"
      [value]="metrics().conversionRate.current.toFixed(1) + '%'"
      [subtitle]="comparisonLabel()"
      [trend]="metrics().conversionRate.trend"
      [change]="metrics().conversionRate.changePercent"
      variant="warning"
    ></app-admin-stat-card>

    <!-- Total Revenue -->
    <app-admin-stat-card
      icon="üí∞"
      label="Revenue Total"
      [value]="formatCurrency(metrics().totalRevenue.current)"
      [subtitle]="comparisonLabel()"
      [trend]="metrics().totalRevenue.trend"
      [change]="metrics().totalRevenue.changePercent"
      variant="success"
    ></app-admin-stat-card>

    <!-- Traffic Sessions -->
    <app-admin-stat-card
      icon="üåê"
      label="Sesiones de Tr√°fico"
      [value]="formatNumber(metrics().trafficSessions.current)"
      [subtitle]="comparisonLabel()"
      [trend]="metrics().trafficSessions.trend"
      [change]="metrics().trafficSessions.changePercent"
      variant="info"
    ></app-admin-stat-card>
  </div>

  <!-- Charts Grid -->
  <div class="charts-section">
    <h2 class="section-title">Gr√°ficos y Tendencias</h2>

    <div class="charts-grid">
      <!-- Revenue Monthly Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üìà Revenue Mensual</h3>
          <div class="chart-actions">
            <button class="btn-icon" title="Pantalla completa">‚õ∂</button>
            <button class="btn-icon" title="Descargar">üíæ</button>
          </div>
        </div>
        <div class="chart-body">
          <div class="chart-placeholder" id="chart-revenue-monthly">
            <div class="mock-chart revenue-chart">
              @for (item of monthlyRevenue(); track item.month) {
              <div class="chart-bar-group">
                <div
                  class="chart-bar current"
                  [style.height.%]="(item.current / 150000) * 100"
                  [title]="formatCurrency(item.current)"
                ></div>
                @if (hasComparison()) {
                <div
                  class="chart-bar previous"
                  [style.height.%]="(item.previous / 150000) * 100"
                  [title]="formatCurrency(item.previous)"
                ></div>
                }
                <span class="chart-label">{{ item.month }}</span>
              </div>
              }
            </div>
            @if (hasComparison()) {
            <div class="chart-legend">
              <span class="legend-item"
                ><span class="legend-color current"></span> Actual</span
              >
              <span class="legend-item"
                ><span class="legend-color previous"></span>
                {{ comparisonLabel() }}</span
              >
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Bookings by Station Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üìä Bookings por Estaci√≥n</h3>
          <div class="chart-actions">
            <button class="btn-icon" title="Pantalla completa">‚õ∂</button>
            <button class="btn-icon" title="Descargar">üíæ</button>
          </div>
        </div>
        <div class="chart-body">
          <div class="chart-placeholder horizontal-bars">
            <div class="bar-chart-item">
              <span class="bar-label">Baqueira-Beret</span>
              <div class="bar-container">
                <div class="bar" style="width: 100%"></div>
                <span class="bar-value">1,245</span>
              </div>
            </div>
            <div class="bar-chart-item">
              <span class="bar-label">Sierra Nevada</span>
              <div class="bar-container">
                <div class="bar" style="width: 79%"></div>
                <span class="bar-value">987</span>
              </div>
            </div>
            <div class="bar-chart-item">
              <span class="bar-label">Formigal</span>
              <div class="bar-container">
                <div class="bar" style="width: 69%"></div>
                <span class="bar-value">856</span>
              </div>
            </div>
            <div class="bar-chart-item">
              <span class="bar-label">Candanch√∫</span>
              <div class="bar-container">
                <div class="bar" style="width: 53%"></div>
                <span class="bar-value">654</span>
              </div>
            </div>
            <div class="bar-chart-item">
              <span class="bar-label">La Molina</span>
              <div class="bar-container">
                <div class="bar" style="width: 44%"></div>
                <span class="bar-value">543</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Revenue Distribution Donut -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üç© Distribuci√≥n de Revenue</h3>
          <div class="chart-actions">
            <button class="btn-icon" title="Pantalla completa">‚õ∂</button>
            <button class="btn-icon" title="Descargar">üíæ</button>
          </div>
        </div>
        <div class="chart-body">
          <div class="donut-chart-container">
            <div class="donut-chart">
              <svg viewBox="0 0 200 200" class="donut-svg">
                <!-- Bookings: 59.5% -->
                <circle
                  cx="100"
                  cy="100"
                  r="80"
                  fill="none"
                  stroke="#3b82f6"
                  stroke-width="40"
                  stroke-dasharray="298 502"
                  transform="rotate(-90 100 100)"
                ></circle>
                <!-- Premium: 21.4% -->
                <circle
                  cx="100"
                  cy="100"
                  r="80"
                  fill="none"
                  stroke="#8b5cf6"
                  stroke-width="40"
                  stroke-dasharray="107 502"
                  stroke-dashoffset="-298"
                  transform="rotate(-90 100 100)"
                ></circle>
                <!-- Comisiones: 13.3% -->
                <circle
                  cx="100"
                  cy="100"
                  r="80"
                  fill="none"
                  stroke="#10b981"
                  stroke-width="40"
                  stroke-dasharray="67 502"
                  stroke-dashoffset="-405"
                  transform="rotate(-90 100 100)"
                ></circle>
                <!-- Publicidad: 5.7% -->
                <circle
                  cx="100"
                  cy="100"
                  r="80"
                  fill="none"
                  stroke="#f59e0b"
                  stroke-width="40"
                  stroke-dasharray="29 502"
                  stroke-dashoffset="-472"
                  transform="rotate(-90 100 100)"
                ></circle>
              </svg>
              <div class="donut-center">
                <span class="donut-total">210K‚Ç¨</span>
                <span class="donut-label">Total</span>
              </div>
            </div>
            <div class="donut-legend">
              <div class="legend-item">
                <span class="legend-dot" style="background: #3b82f6"></span>
                Bookings (125K‚Ç¨)
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: #8b5cf6"></span>
                Premium (45K‚Ç¨)
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: #10b981"></span>
                Comisiones (28K‚Ç¨)
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: #f59e0b"></span>
                Publicidad (12K‚Ç¨)
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Users Daily Area Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üìä Usuarios Activos Diarios (30d)</h3>
          <div class="chart-actions">
            <button class="btn-icon" title="Pantalla completa">‚õ∂</button>
            <button class="btn-icon" title="Descargar">üíæ</button>
          </div>
        </div>
        <div class="chart-body">
          <div class="area-chart-placeholder">
            <svg viewBox="0 0 800 200" class="area-chart-svg">
              <!-- Simplified area chart mock -->
              <defs>
                <linearGradient
                  id="areaGradient"
                  x1="0%"
                  y1="0%"
                  x2="0%"
                  y2="100%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #3b82f6; stop-opacity: 0.3"
                  />
                  <stop
                    offset="100%"
                    style="stop-color: #3b82f6; stop-opacity: 0"
                  />
                </linearGradient>
              </defs>
              <path
                d="M 0 120 Q 100 80 200 100 T 400 90 T 600 110 T 800 80 L 800 200 L 0 200 Z"
                fill="url(#areaGradient)"
                stroke="#3b82f6"
                stroke-width="2"
              />
            </svg>
          </div>
        </div>
      </div>

      <!-- Activity Heatmap -->
      <div class="chart-card wide">
        <div class="chart-header">
          <h3 class="chart-title">üî• Actividad por D√≠a y Hora</h3>
          <div class="chart-actions">
            <button class="btn-icon" title="Pantalla completa">‚õ∂</button>
            <button class="btn-icon" title="Descargar">üíæ</button>
          </div>
        </div>
        <div class="chart-body">
          <div class="heatmap-container">
            <div class="heatmap-grid">
              <div class="heatmap-labels-y">
                <span>Lun</span>
                <span>Mar</span>
                <span>Mi√©</span>
                <span>Jue</span>
                <span>Vie</span>
                <span>S√°b</span>
                <span>Dom</span>
              </div>
              <div class="heatmap-cells">
                @for (day of [0,1,2,3,4,5,6]; track day) {
                <div class="heatmap-row">
                  @for (hour of
                  [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23];
                  track hour) {
                  <div
                    class="heatmap-cell"
                    [class.low]="(hour < 9 || hour > 22) && day < 5"
                    [class.medium]="(hour >= 9 && hour <= 18) || day >= 5"
                    [class.high]="hour >= 19 && hour <= 22 && day >= 5"
                    [title]="
                      'Actividad: ' +
                      (hour >= 9 && hour <= 22 ? 'Alta' : 'Baja')
                    "
                  ></div>
                  }
                </div>
                }
              </div>
              <div class="heatmap-labels-x">
                <span>0h</span>
                <span>6h</span>
                <span>12h</span>
                <span>18h</span>
                <span>23h</span>
              </div>
            </div>
            <div class="heatmap-legend">
              <span>Menos</span>
              <div class="legend-scale">
                <div class="scale-cell low"></div>
                <div class="scale-cell medium"></div>
                <div class="scale-cell high"></div>
              </div>
              <span>M√°s</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Conversion Funnel -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üéØ Embudo de Conversi√≥n</h3>
          <div class="chart-actions">
            <button class="btn-icon" title="Pantalla completa">‚õ∂</button>
            <button class="btn-icon" title="Descargar">üíæ</button>
          </div>
        </div>
        <div class="chart-body">
          <div class="funnel-container">
            @for (stage of funnelData(); track stage.stage) {
            <div class="funnel-stage">
              <div class="funnel-bar" [style.width.%]="stage.percentage">
                <span class="funnel-label">{{ stage.stage }}</span>
                <span class="funnel-value">{{
                  formatNumber(stage.value)
                }}</span>
              </div>
              <span class="funnel-percentage"
                >{{ stage.percentage.toFixed(1) }}%</span
              >
              @if (stage.dropOff > 0) {
              <span class="funnel-dropoff"
                >-{{ stage.dropOff.toFixed(1) }}%</span
              >
              }
            </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
  }
</div>
