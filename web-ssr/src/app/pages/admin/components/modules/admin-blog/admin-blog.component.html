<div class="admin-blog-container">
  <!-- Breadcrumbs -->
  <app-admin-breadcrumbs [items]="breadcrumbs" />

  <!-- Page Header -->
  <div class="admin-header">
    <div class="header-content">
      <h1 class="page-title">📝 Blog & Contenidos</h1>
      <p class="page-description">
        Gestión completa de artículos, categorías y autores con editor WYSIWYG
      </p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      ➕ Nuevo Artículo
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <app-admin-stat-card
      [label]="'Total Artículos'"
      [value]="stats().totalArticles"
      icon="📄"
      variant="primary"
    />
    <app-admin-stat-card
      [label]="'Publicados'"
      [value]="stats().published"
      icon="✅"
      variant="success"
    />
    <app-admin-stat-card
      [label]="'Borradores'"
      [value]="stats().drafts"
      icon="📝"
      variant="warning"
    />
    <app-admin-stat-card
      [label]="'Total Vistas'"
      [value]="stats().totalViews"
      icon="👁️"
      variant="info"
      format="number"
    />
  </div>

  <!-- Search and Filters -->
  <div class="admin-toolbar">
    <app-admin-search-bar
      placeholder="Buscar por título, slug, autor..."
      (search)="handleSearch($any($event))"
    />
    <app-admin-filters
      [fields]="filterFields"
      (filterChange)="
        handleFilterChange($any($event).filterId, $any($event).value)
      "
    />
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <app-admin-loader message="Cargando artículos..." />
  }

  <!-- Error State -->
  @else if (error()) {
  <div class="error-message">
    <span class="icon">⚠️</span>
    <p>{{ error() }}</p>
  </div>
  }

  <!-- Table -->
  @else {
  <app-admin-table
    [columns]="tableColumns"
    [data]="paginatedArticles()"
    [actions]="tableActions"
    (rowClick)="handleRowClick($event)"
    (actionClick)="handleActionClick($any($event))"
  >
    <!-- Custom column templates -->
    <ng-template #customColumn let-column="column" let-row="row">
      @if (column.key === 'title') {
      <div class="article-title-cell">
        <div class="title-main">{{ row.title.es }}</div>
        @if (row.featured) {
        <span class="featured-badge">⭐ Destacado</span>
        } @if (row.sticky) {
        <span class="sticky-badge">📌 Fijado</span>
        }
      </div>
      } @if (column.key === 'author') {
      <div class="author-cell">
        <img
          [src]="row.author.avatar"
          [alt]="row.author.name"
          class="author-avatar"
        />
        <span>{{ row.author.name }}</span>
      </div>
      } @if (column.key === 'categories') {
      <div class="categories-cell">
        @for (category of row.categories; track category.id) {
        <app-admin-badge
          [text]="category.name.es"
          [variant]="'info'"
          size="sm"
        />
        }
      </div>
      } @if (column.key === 'status') {
      <app-admin-badge
        [text]="getStatusLabel(row.status)"
        [variant]="getStatusBadgeVariant(row.status)"
      />
      } @if (column.key === 'views') {
      <span class="stats-cell">{{ formatNumber(row.stats.views) }}</span>
      } @if (column.key === 'publishedAt') {
      <span class="date-cell">{{ formatDate(row.publishedAt) }}</span>
      }
    </ng-template>
  </app-admin-table>

  <!-- Pagination -->
  <app-admin-pagination
    [page]="currentPage()"
    [total]="filteredArticles().length"
    [pageSize]="itemsPerPage()"
    (pageChange)="handlePageChange($event)"
  />
  }

  <!-- Create/Edit Modal -->
  @if (showModal()) {
  <app-admin-modal
    [open]="true"
    [title]="isEditMode() ? 'Editar Artículo' : 'Nuevo Artículo'"
    size="xl"
    (close)="closeModal()"
  >
    <div class="modal-content">
      <!-- Language Tabs -->
      <div class="language-tabs">
        <button
          type="button"
          class="lang-tab"
          [class.active]="currentLanguage() === 'es'"
          (click)="currentLanguage.set('es')"
        >
          🇪🇸 Español
        </button>
        <button
          type="button"
          class="lang-tab"
          [class.active]="currentLanguage() === 'en'"
          (click)="currentLanguage.set('en')"
        >
          🇬🇧 English
        </button>
        <button
          type="button"
          class="lang-tab"
          [class.active]="currentLanguage() === 'fr'"
          (click)="currentLanguage.set('fr')"
        >
          🇫🇷 Français
        </button>
      </div>

      <!-- Content Tabs -->
      <div class="content-tabs">
        <button
          type="button"
          class="content-tab"
          [class.active]="activeTab() === 'content'"
          (click)="activeTab.set('content')"
        >
          📝 Contenido
        </button>
        <button
          type="button"
          class="content-tab"
          [class.active]="activeTab() === 'seo'"
          (click)="activeTab.set('seo')"
        >
          🔍 SEO
        </button>
        <button
          type="button"
          class="content-tab"
          [class.active]="activeTab() === 'settings'"
          (click)="activeTab.set('settings')"
        >
          ⚙️ Configuración
        </button>
      </div>

      <form class="admin-form">
        <!-- Content Tab -->
        @if (activeTab() === 'content') {
        <div class="form-section">
          <h3 class="section-title">Información Básica</h3>

          <div class="form-group">
            <label [attr.for]="'title-' + currentLanguage()">Título *</label>
            <input
              type="text"
              [id]="'title-' + currentLanguage()"
              class="form-input"
              [(ngModel)]="formData().title[currentLanguage()]"
              [name]="'title-' + currentLanguage()"
              placeholder="Título del artículo"
              required
            />
          </div>

          <div class="form-group">
            <label for="slug">URL Slug *</label>
            <div class="input-with-button">
              <input
                type="text"
                id="slug"
                class="form-input"
                [(ngModel)]="formData().slug"
                name="slug"
                placeholder="mi-articulo-genial"
                required
              />
              <button
                type="button"
                class="generate-slug-btn"
                (click)="autoGenerateSlug()"
                title="Generar automáticamente desde el título"
              >
                ✨ Auto
              </button>
            </div>
          </div>

          <div class="form-group">
            <label [attr.for]="'excerpt-' + currentLanguage()">Extracto</label>
            <textarea
              [id]="'excerpt-' + currentLanguage()"
              class="form-textarea"
              [(ngModel)]="formData().excerpt[currentLanguage()]"
              [name]="'excerpt-' + currentLanguage()"
              rows="3"
              placeholder="Breve resumen del artículo (máx. 160 caracteres)"
            ></textarea>
          </div>

          <div class="form-group">
            <label [attr.for]="'content-' + currentLanguage()"
              >Contenido *</label
            >
            <div class="wysiwyg-editor">
              <div class="editor-toolbar">
                <button type="button" class="editor-btn" title="Negrita">
                  <strong>B</strong>
                </button>
                <button type="button" class="editor-btn" title="Cursiva">
                  <em>I</em>
                </button>
                <button type="button" class="editor-btn" title="Subrayado">
                  <u>U</u>
                </button>
                <span class="toolbar-separator"></span>
                <button type="button" class="editor-btn" title="Título 1">
                  H1
                </button>
                <button type="button" class="editor-btn" title="Título 2">
                  H2
                </button>
                <button type="button" class="editor-btn" title="Título 3">
                  H3
                </button>
                <span class="toolbar-separator"></span>
                <button type="button" class="editor-btn" title="Lista">
                  📝
                </button>
                <button type="button" class="editor-btn" title="Link">
                  🔗
                </button>
                <button type="button" class="editor-btn" title="Imagen">
                  🖼️
                </button>
                <button type="button" class="editor-btn" title="Código">
                  💻
                </button>
              </div>
              <textarea
                [id]="'content-' + currentLanguage()"
                class="form-textarea editor-content"
                [(ngModel)]="formData().content[currentLanguage()]"
                [name]="'content-' + currentLanguage()"
                rows="15"
                placeholder="Escribe el contenido del artículo aquí..."
              ></textarea>
            </div>
          </div>

          <div class="form-group">
            <label for="featuredImage">Imagen Destacada</label>
            <input
              type="url"
              id="featuredImage"
              class="form-input"
              [(ngModel)]="formData().featuredImage.url"
              name="featuredImage"
              placeholder="https://ejemplo.com/imagen.jpg"
            />
          </div>

          <div class="form-group">
            <label for="imageAlt">Texto Alternativo (Alt)</label>
            <input
              type="text"
              id="imageAlt"
              class="form-input"
              [(ngModel)]="formData().featuredImage.alt"
              name="imageAlt"
              placeholder="Descripción de la imagen"
            />
          </div>
        </div>
        }

        <!-- SEO Tab -->
        @if (activeTab() === 'seo') {
        <div class="form-section">
          <h3 class="section-title">Optimización SEO</h3>

          <div class="form-group">
            <label [attr.for]="'metaTitle-' + currentLanguage()"
              >Meta Título</label
            >
            <input
              type="text"
              [id]="'metaTitle-' + currentLanguage()"
              class="form-input"
              [(ngModel)]="formData().seo.metaTitle[currentLanguage()]"
              [name]="'metaTitle-' + currentLanguage()"
              placeholder="Título para motores de búsqueda (máx. 60 caracteres)"
              maxlength="60"
            />
            <small class="char-counter">
              {{ formData().seo.metaTitle[currentLanguage()].length || 0 }} / 60
            </small>
          </div>

          <div class="form-group">
            <label [attr.for]="'metaDescription-' + currentLanguage()"
              >Meta Descripción</label
            >
            <textarea
              [id]="'metaDescription-' + currentLanguage()"
              class="form-textarea"
              [(ngModel)]="formData().seo.metaDescription[currentLanguage()]"
              [name]="'metaDescription-' + currentLanguage()"
              rows="3"
              placeholder="Descripción para motores de búsqueda (máx. 160 caracteres)"
              maxlength="160"
            ></textarea>
            <small class="char-counter">
              {{
                formData().seo.metaDescription[currentLanguage()].length || 0
              }}
              / 160
            </small>
          </div>

          <div class="form-group">
            <label for="keywords">Palabras Clave (separadas por comas)</label>
            <input
              type="text"
              id="keywords"
              class="form-input"
              [value]="formData().seo.keywords.join(', ')"
              (input)="handleKeywordsChange($event)"
              name="keywords"
              placeholder="esquí, nieve, montaña, resort"
            />
          </div>

          <div class="form-group">
            <label for="canonical">URL Canónica</label>
            <input
              type="url"
              id="canonical"
              class="form-input"
              [(ngModel)]="formData().seo.canonical"
              name="canonical"
              placeholder="https://ejemplo.com/articulo-original"
            />
          </div>

          <div class="form-group">
            <label for="ogImage">Imagen Open Graph</label>
            <input
              type="url"
              id="ogImage"
              class="form-input"
              [(ngModel)]="formData().seo.ogImage"
              name="ogImage"
              placeholder="https://ejemplo.com/og-image.jpg"
            />
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="formData().seo.noindex"
                name="noindex"
              />
              <span>No indexar (noindex)</span>
            </label>
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="formData().seo.nofollow"
                name="nofollow"
              />
              <span>No seguir enlaces (nofollow)</span>
            </label>
          </div>
        </div>
        }

        <!-- Settings Tab -->
        @if (activeTab() === 'settings') {
        <div class="form-section">
          <h3 class="section-title">Configuración del Artículo</h3>

          <div class="form-row">
            <div class="form-group">
              <label for="status">Estado *</label>
              <select
                id="status"
                class="form-select"
                [(ngModel)]="formData().status"
                name="status"
                required
              >
                <option value="draft">Borrador</option>
                <option value="published">Publicado</option>
                <option value="scheduled">Programado</option>
                <option value="archived">Archivado</option>
              </select>
            </div>

            <div class="form-group">
              <label for="visibility">Visibilidad</label>
              <select
                id="visibility"
                class="form-select"
                [(ngModel)]="formData().visibility"
                name="visibility"
              >
                <option value="public">Pública</option>
                <option value="private">Privada</option>
                <option value="password">Protegida por contraseña</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="format">Formato</label>
              <select
                id="format"
                class="form-select"
                [(ngModel)]="formData().format"
                name="format"
              >
                <option value="standard">Estándar</option>
                <option value="gallery">Galería</option>
                <option value="video">Video</option>
                <option value="quote">Cita</option>
              </select>
            </div>

            <div class="form-group">
              <label for="author">Autor *</label>
              <select
                id="author"
                class="form-select"
                [(ngModel)]="formData().authorId"
                name="author"
                required
              >
                <option value="">Seleccionar autor...</option>
                @for (author of authors(); track author.id) {
                <option [value]="author.id">{{ author.name }}</option>
                }
              </select>
            </div>
          </div>

          @if (formData().status === 'scheduled') {
          <div class="form-group">
            <label for="scheduledAt">Fecha de Publicación</label>
            <input
              type="datetime-local"
              id="scheduledAt"
              class="form-input"
              [(ngModel)]="formData().scheduledAt"
              name="scheduledAt"
            />
          </div>
          }

          <div class="form-group">
            <label for="categories">Categorías</label>
            <div class="multi-select">
              @for (category of categories(); track category.id) {
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="formData().categoryIds.includes(category.id)"
                  (change)="
                    $any($event.target).checked
                      ? formData().categoryIds.push(category.id)
                      : formData().categoryIds.splice(
                          formData().categoryIds.indexOf(category.id),
                          1
                        )
                  "
                />
                <span>{{ category.name.es }}</span>
              </label>
              }
            </div>
          </div>

          <div class="form-group">
            <label for="tags">Etiquetas (separadas por comas)</label>
            <input
              type="text"
              id="tags"
              class="form-input"
              [value]="formData().tags.join(', ')"
              (input)="handleTagsChange($event)"
              name="tags"
              placeholder="nieve, esquí, tutorial"
            />
          </div>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="formData().featured"
                name="featured"
              />
              <span>⭐ Artículo destacado</span>
            </label>
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="formData().sticky"
                name="sticky"
              />
              <span>📌 Fijar en la parte superior</span>
            </label>
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="formData().allowComments"
                name="allowComments"
              />
              <span>💬 Permitir comentarios</span>
            </label>
          </div>
        </div>
        }
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="handleSave()">
        💾 {{ isEditMode() ? "Actualizar" : "Crear" }}
      </button>
    </div>
  </app-admin-modal>
  }

  <!-- Delete Confirmation Dialog -->
  @if (showDeleteDialog()) {
  <app-admin-confirm-dialog
    [open]="true"
    title="Eliminar Artículo"
    [message]="getDeleteMessage()"
    confirmLabel="Eliminar"
    cancelLabel="Cancelar"
    variant="danger"
    (confirm)="handleDelete()"
    (cancel)="closeDeleteDialog()"
  />
  }
</div>
