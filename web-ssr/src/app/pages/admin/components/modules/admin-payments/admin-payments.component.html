<div class="admin-payments">
  <!-- Breadcrumbs -->
  <app-admin-breadcrumbs [items]="breadcrumbs"></app-admin-breadcrumbs>

  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Pagos y Finanzas</h1>
      <p class="page-description">
        Gestiona pagos, facturaci√≥n, reembolsos y pagos a estaciones
      </p>
    </div>
    <div class="header-actions">
      <button
        class="btn btn-secondary"
        (click)="exportData()"
        [disabled]="isLoading()"
      >
        <span class="btn-icon">üìä</span>
        Exportar datos
      </button>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <app-admin-stat-card
      title="Pagos totales"
      [value]="formatCurrency(stats().totalPayments)"
      trend="up"
      trendValue="+12.5%"
      icon="üí≥"
      color="primary"
    >
    </app-admin-stat-card>

    <app-admin-stat-card
      title="Reembolsos pendientes"
      [value]="stats().pendingRefunds.toString()"
      trend="down"
      trendValue="-3"
      icon="üîÑ"
      color="warning"
    >
    </app-admin-stat-card>

    <app-admin-stat-card
      title="Ingresos del mes"
      [value]="formatCurrency(stats().monthlyRevenue)"
      trend="up"
      trendValue="+8.2%"
      icon="üìà"
      color="success"
    >
    </app-admin-stat-card>

    <app-admin-stat-card
      title="Comisiones"
      [value]="formatCurrency(stats().commissions)"
      trend="up"
      trendValue="+5.1%"
      icon="üí∞"
      color="info"
    >
    </app-admin-stat-card>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <div class="tabs">
      <button
        class="tab"
        [class.active]="activeTab() === 'payments'"
        (click)="onTabChange('payments')"
      >
        üí≥ Pagos
      </button>
      <button
        class="tab"
        [class.active]="activeTab() === 'invoices'"
        (click)="onTabChange('invoices')"
      >
        üìÑ Facturas
      </button>
      <button
        class="tab"
        [class.active]="activeTab() === 'refunds'"
        (click)="onTabChange('refunds')"
      >
        üîÑ Reembolsos
      </button>
      <button
        class="tab"
        [class.active]="activeTab() === 'payouts'"
        (click)="onTabChange('payouts')"
      >
        üè¶ Pagos a estaciones
      </button>
    </div>
  </div>

  <!-- Payments Tab -->
  @if (activeTab() === 'payments') {
  <div class="tab-content">
    <!-- Filters Bar -->
    <div class="filters-bar">
      <app-admin-search-bar
        placeholder="Buscar por ID, cliente, estaci√≥n..."
        (search)="onSearch($event)"
      >
      </app-admin-search-bar>

      <div class="filters-group">
        <app-admin-date-range-picker (rangeChange)="onDateRangeChange($event)">
        </app-admin-date-range-picker>

        <select
          class="filter-select"
          [value]="statusFilter()"
          (change)="onStatusFilterChange($any($event.target).value)"
        >
          @for (option of statusOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
          }
        </select>

        <select
          class="filter-select"
          [value]="methodFilter()"
          (change)="onMethodFilterChange($any($event.target).value)"
        >
          @for (option of methodOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Table -->
    @if (isLoading()) {
    <app-admin-loader message="Cargando pagos..."></app-admin-loader>
    } @else if (paginatedPayments().length === 0) {
    <app-admin-empty-state
      icon="üí≥"
      title="No hay pagos"
      description="No se encontraron pagos que coincidan con los filtros seleccionados."
    >
    </app-admin-empty-state>
    } @else {
    <div class="table-container">
      <table class="payments-table">
        <thead>
          <tr>
            @for (col of paymentColumns; track col.key) {
            <th>{{ col.label }}</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (payment of paginatedPayments(); track payment.id) {
          <tr>
            <td class="payment-id">{{ payment.id }}</td>
            <td class="customer-name">{{ payment.customerName }}</td>
            <td class="station-name">{{ payment.stationName }}</td>
            <td class="payment-amount">{{ formatCurrency(payment.amount) }}</td>
            <td class="payment-method">{{ formatMethod(payment.method) }}</td>
            <td>
              <app-admin-badge
                [label]="formatStatus(payment.status)"
                [type]="getStatusBadgeType(payment.status)"
              >
              </app-admin-badge>
            </td>
            <td class="payment-date">{{ formatDate(payment.processedAt) }}</td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button
                  class="btn-icon-action"
                  (click)="viewPaymentDetails(payment)"
                  title="Ver detalles"
                >
                  üëÅÔ∏è
                </button>
                @if (payment.status === 'completed') {
                <button
                  class="btn-icon-action"
                  (click)="openRefundModal(payment)"
                  title="Procesar reembolso"
                >
                  üîÑ
                </button>
                } @if (payment.status === 'pending') {
                <button
                  class="btn-icon-action danger"
                  (click)="cancelPayment(payment)"
                  title="Cancelar pago"
                >
                  ‚ùå
                </button>
                }
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <app-admin-pagination
      [currentPage]="currentPage()"
      [totalItems]="totalPayments()"
      [pageSize]="pageSize()"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
    >
    </app-admin-pagination>
    }
  </div>
  }

  <!-- Invoices Tab -->
  @if (activeTab() === 'invoices') {
  <div class="tab-content">
    <div class="tab-header">
      <h2 class="tab-title">Facturas</h2>
      <button class="btn btn-primary" (click)="openInvoiceModal()">
        <span class="btn-icon">‚ûï</span>
        Nueva factura
      </button>
    </div>

    <div class="table-container">
      <table class="invoices-table">
        <thead>
          <tr>
            @for (col of invoiceColumns; track col.key) {
            <th>{{ col.label }}</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (invoice of allInvoices(); track invoice.id) {
          <tr>
            <td class="invoice-id">{{ invoice.id }}</td>
            <td class="invoice-amount">{{ formatCurrency(invoice.amount) }}</td>
            <td>
              <app-admin-badge
                [label]="invoice.status === 'paid' ? 'Pagada' : 'Pendiente'"
                [type]="invoice.status === 'paid' ? 'success' : 'warning'"
              >
              </app-admin-badge>
            </td>
            <td>{{ invoice.issueDate }}</td>
            <td>{{ invoice.dueDate }}</td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button
                  class="btn-icon-action"
                  (click)="downloadInvoice(invoice)"
                  title="Descargar PDF"
                >
                  üì•
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }

  <!-- Refunds Tab -->
  @if (activeTab() === 'refunds') {
  <div class="tab-content">
    <h2 class="tab-title">Reembolsos</h2>

    <div class="table-container">
      <table class="refunds-table">
        <thead>
          <tr>
            @for (col of refundColumns; track col.key) {
            <th>{{ col.label }}</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (refund of allRefunds(); track refund.id) {
          <tr>
            <td>{{ refund.id }}</td>
            <td>{{ refund.paymentId }}</td>
            <td>{{ formatCurrency(refund.amount) }}</td>
            <td>{{ refund.reason }}</td>
            <td>
              <app-admin-badge
                [label]="
                  refund.status === 'completed' ? 'Completado' : 'Pendiente'
                "
                [type]="refund.status === 'completed' ? 'success' : 'warning'"
              >
              </app-admin-badge>
            </td>
            <td>{{ formatDate(refund.requestedAt) }}</td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="btn-icon-action" title="Ver detalles">üëÅÔ∏è</button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }

  <!-- Payouts Tab -->
  @if (activeTab() === 'payouts') {
  <div class="tab-content">
    <div class="tab-header">
      <h2 class="tab-title">Pagos a estaciones</h2>
      <button class="btn btn-primary" (click)="openPayoutModal()">
        <span class="btn-icon">‚ûï</span>
        Nuevo pago
      </button>
    </div>

    <div class="table-container">
      <table class="payouts-table">
        <thead>
          <tr>
            @for (col of payoutColumns; track col.key) {
            <th>{{ col.label }}</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (payout of allPayouts(); track payout.id) {
          <tr>
            <td>{{ payout.id }}</td>
            <td>{{ payout.stationId }}</td>
            <td>{{ formatCurrency(payout.amount) }}</td>
            <td>{{ formatMethod(payout.method) }}</td>
            <td>
              <app-admin-badge
                [label]="
                  payout.status === 'completed' ? 'Completado' : 'Pendiente'
                "
                [type]="payout.status === 'completed' ? 'success' : 'warning'"
              >
              </app-admin-badge>
            </td>
            <td>{{ payout.scheduledAt }}</td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="btn-icon-action" title="Ver detalles">üëÅÔ∏è</button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }

  <!-- Refund Modal -->
  @if (showRefundModal()) {
  <app-admin-modal title="Procesar reembolso" (close)="closeModal()">
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group span-2">
          <label class="form-label" for="refund-payment-id"
            >Pago original</label
          >
          <input
            id="refund-payment-id"
            type="text"
            class="form-control"
            [value]="selectedPayment()?.id || ''"
            disabled
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="refund-customer">Cliente</label>
          <input
            id="refund-customer"
            type="text"
            class="form-control"
            [value]="selectedPayment()?.customerName || ''"
            disabled
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="refund-original-amount"
            >Importe original</label
          >
          <input
            id="refund-original-amount"
            type="text"
            class="form-control"
            [value]="formatCurrency(selectedPayment()?.amount || 0)"
            disabled
          />
        </div>

        <div class="form-group">
          <label class="form-label required" for="refund-amount"
            >Importe a reembolsar</label
          >
          <input
            id="refund-amount"
            type="number"
            class="form-control"
            [(ngModel)]="refundForm().amount"
            [max]="selectedPayment()?.amount || 0"
            step="0.01"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label required" for="refund-reason">Motivo</label>
          <select
            id="refund-reason"
            class="form-control"
            [(ngModel)]="refundForm().reason"
            required
          >
            <option value="">Selecciona un motivo</option>
            <option value="customer_request">Solicitud del cliente</option>
            <option value="duplicate">Pago duplicado</option>
            <option value="fraudulent">Fraude</option>
            <option value="service_not_provided">Servicio no prestado</option>
            <option value="other">Otro</option>
          </select>
        </div>

        <div class="form-group span-2">
          <label class="form-label" for="refund-notes">Notas</label>
          <textarea
            id="refund-notes"
            class="form-control"
            [(ngModel)]="refundForm().notes"
            rows="4"
            placeholder="Informaci√≥n adicional sobre el reembolso..."
          ></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
      <button
        class="btn btn-primary"
        (click)="processRefund()"
        [disabled]="isLoading() || !refundForm().reason"
      >
        @if (isLoading()) {
        <span>Procesando...</span>
        } @else {
        <span>Procesar reembolso</span>
        }
      </button>
    </div>
  </app-admin-modal>
  }

  <!-- Invoice Modal -->
  @if (showInvoiceModal()) {
  <app-admin-modal title="Nueva factura" (close)="closeModal()">
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label required" for="invoice-booking-id"
            >ID Reserva</label
          >
          <input
            id="invoice-booking-id"
            type="text"
            class="form-control"
            [(ngModel)]="invoiceForm().bookingId"
            placeholder="BK001"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label required" for="invoice-due-date"
            >Fecha de vencimiento</label
          >
          <input
            id="invoice-due-date"
            type="date"
            class="form-control"
            [(ngModel)]="invoiceForm().dueDate"
            required
          />
        </div>

        <div class="form-group span-2">
          <label class="form-label" for="invoice-notes">Notas</label>
          <textarea
            id="invoice-notes"
            class="form-control"
            [(ngModel)]="invoiceForm().notes"
            rows="4"
            placeholder="Notas adicionales para la factura..."
          ></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
      <button
        class="btn btn-primary"
        (click)="generateInvoice()"
        [disabled]="
          isLoading() || !invoiceForm().bookingId || !invoiceForm().dueDate
        "
      >
        @if (isLoading()) {
        <span>Generando...</span>
        } @else {
        <span>Generar factura</span>
        }
      </button>
    </div>
  </app-admin-modal>
  }

  <!-- Payout Modal -->
  @if (showPayoutModal()) {
  <app-admin-modal title="Nuevo pago a estaci√≥n" (close)="closeModal()">
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label required" for="payout-station"
            >Estaci√≥n</label
          >
          <select
            id="payout-station"
            class="form-control"
            [(ngModel)]="payoutForm().stationId"
            required
          >
            <option value="">Selecciona una estaci√≥n</option>
            <option value="sierra-nevada">Sierra Nevada</option>
            <option value="baqueira-beret">Baqueira Beret</option>
            <option value="formigal">Formigal</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label required" for="payout-amount">Importe</label>
          <input
            id="payout-amount"
            type="number"
            class="form-control"
            [(ngModel)]="payoutForm().amount"
            step="0.01"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label required" for="payout-method">M√©todo</label>
          <select
            id="payout-method"
            class="form-control"
            [(ngModel)]="payoutForm().method"
            required
          >
            <option value="bank_transfer">Transferencia bancaria</option>
            <option value="paypal">PayPal</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="payout-reference">Referencia</label>
          <input
            id="payout-reference"
            type="text"
            class="form-control"
            [(ngModel)]="payoutForm().reference"
            placeholder="N√∫mero de referencia"
          />
        </div>

        <div class="form-group span-2">
          <label class="form-label" for="payout-notes">Notas</label>
          <textarea
            id="payout-notes"
            class="form-control"
            [(ngModel)]="payoutForm().notes"
            rows="4"
            placeholder="Notas adicionales sobre el pago..."
          ></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
      <button
        class="btn btn-primary"
        (click)="createPayout()"
        [disabled]="
          isLoading() || !payoutForm().stationId || payoutForm().amount <= 0
        "
      >
        @if (isLoading()) {
        <span>Creando...</span>
        } @else {
        <span>Crear pago</span>
        }
      </button>
    </div>
  </app-admin-modal>
  }

  <!-- Payment Details Modal -->
  @if (showDetailsModal() && selectedPayment()) {
  <app-admin-modal title="Detalles del pago" (close)="closeModal()">
    <div class="modal-body">
      <div class="details-grid">
        <div class="detail-item">
          <span class="detail-label">ID Pago</span>
          <span class="detail-value">{{ selectedPayment()?.id }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Cliente</span>
          <span class="detail-value">{{
            selectedPayment()?.customerName
          }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Estaci√≥n</span>
          <span class="detail-value">{{ selectedPayment()?.stationName }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Importe</span>
          <span class="detail-value">{{
            formatCurrency(selectedPayment()?.amount || 0)
          }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">M√©todo</span>
          <span class="detail-value">{{
            formatMethod(selectedPayment()?.method!)
          }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Estado</span>
          <app-admin-badge
            [label]="formatStatus(selectedPayment()?.status!)"
            [type]="getStatusBadgeType(selectedPayment()?.status!)"
          >
          </app-admin-badge>
        </div>
        <div class="detail-item">
          <span class="detail-label">Fecha procesamiento</span>
          <span class="detail-value">{{
            formatDate(selectedPayment()?.processedAt!)
          }}</span>
        </div>
        @if (selectedPayment()?.invoiceNumber) {
        <div class="detail-item">
          <span class="detail-label">Factura</span>
          <span class="detail-value">{{
            selectedPayment()?.invoiceNumber
          }}</span>
        </div>
        }
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cerrar</button>
    </div>
  </app-admin-modal>
  }

  <!-- Confirmation Dialog -->
  @if (showCancelDialog()) {
  <app-admin-confirm-dialog
    [title]="confirmationTitle()"
    [message]="confirmationMessage()"
    confirmText="Confirmar"
    cancelText="Cancelar"
    (confirm)="confirmAction()"
    (cancel)="closeModal()"
  >
  </app-admin-confirm-dialog>
  }

  <!-- Toast -->
  @if (showToast()) {
  <app-admin-toast
    [message]="toastMessage()"
    [type]="toastType()"
    (close)="showToast.set(false)"
  >
  </app-admin-toast>
  }
</div>
